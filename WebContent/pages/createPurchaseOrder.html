<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Add Material | STOMAN</title>
<link href="../resources/uniform.default.css" rel="stylesheet"
	type="text/css" media="all">
<link href="../resources/uniform.aristo.css" rel="stylesheet"
	type="text/css" media="all">
<link href="../resources/style.css" rel="stylesheet" type="text/css"
	media="all">
<link href="../resources/jquery.autocomplete.css" rel="stylesheet" type="text/css" media="all">
<script src="../resources/jquery-1.4.js" type="text/javascript"></script>
<script src="../resources/jquery.uniform.min.js" type="text/javascript"></script>
<script type='text/javascript' src='../dwr/engine.js'></script>
<script type='text/javascript' src='../dwr/util.js'></script>
<script type='text/javascript' src='../dwr/interface/Material.js'></script>
<script type='text/javascript' src='../resources/common.js'></script>
<script type='text/javascript' src='../resources/jquery.autocomplete.js'></script>
<script type='text/javascript' src='../dwr/engine.js'></script>
<script type='text/javascript' src='../dwr/util.js'></script>
<script type='text/javascript' src='../dwr/interface/PurchaseOrder.js'></script>
<script type='text/javascript' src='../resources/jconfirmaction.jquery.js'></script>


<script type="text/javascript">
var oInvalid = false;
	$(document).ready(function(){
		pageInit('cpo');
		$('a.shortbutton').click(buildPO).focus();
	});

	function buildPO() {
		var po = $('#purchase-order')
		.clone()
		.removeAttr('id')
		.css('display', 'inline')
		.insertBefore($('#cntrl'));
		po.find('#material').autocomplete('../auto/complete', { 
			matchContains: true,
			cacheLength: 10,
			maxItemsToShow: 9,
			delay: 1,	
			mustMatch: 1,
			handleMustMatch: 1,
			extraParams: { method: 'getMaterials' }
		}).blur(generate);
		po.find('#qty').focus().blur(generate);
		po.find('#newMaterial').jConfirmAction({question : "Material not found!", yesAnswer : "Add", cancelAnswer : "Cancel"});
	}
	
	function generate() {
		if(oInvalid) {
			oInvalid = false;
			return;
		}
		var obj = {};
		$('table.purchase-order').each(function(i, tbl) {
			//alert('sdfd');
			var material = $(tbl).find('#material');
			var quantity = $(tbl).find('#qty');
			if(material.val() != '' && quantity.val())
				obj[material.val()] = obj[material.val()] 
						? obj[material.val()] + parseInt(quantity.val())
						: parseInt(quantity.val());
		});
		PurchaseOrder.generate(obj, function(data) {
			var po = $('#po-confirm');
			//po.innerHTML = "";
			
			$.each(data, function(vId, vM) {
				$.each(vM, function(i, ele) {
					$('<div/>').html(ele.materials.name).appendTo(po);
				});
			});
		});
	}
	
	function handleMustMatch(ele) {
		oInvalid = true;
		$(ele).siblings('#newMaterial').click();
	}
	
	function JConfirmCallback(ele, stat) {
		if(stat == "n") {
			$(ele).siblings('#material').focus();
		} else {
			oInvalid = false;
		}
	}
</script>

</head>
<body >
<form id="create-purchaseorder">
<table width="100%" style="padding-top: 20px;">
<tbody id="orders">
	<tr>
		<td colspan="4">
			<div style="width: 250px; padding-top:10px; display: none; float: left;" id="purchase-order" name="purchase-order">
				<table class="purchase-order">
					<tbody>
						<tr>
							<td rowspan="2">
								<input id="qty" type="text" class="text purchase-order-qty" />
							</td>
							<td>
								<label style="color: #d6dee6;">nos.</label><div style="float: right;">
								<label style="cursor: pointer; color: #d6dee6;" onclick="$(this).parents('.purchase-order').parent().remove();">del</label></div> <br/>
								<input id="material" type="text" class="text purchase-order-material"/>
								<a id="newMaterial" href="#"></a>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div id="cntrl">
				<a href="#" style="margin-top: 40px;" class="shortbutton">add</a>
			</div>
		</td>
	</tr>
</tbody>	
</table>
<div id="po-confirm">
	
</div>
</form>

</body>
</html>